stages:
  - build
  - test
  - deploy

# cache maven repo & nodejs modules
cache:
  paths:
    - apt-cache/
    - .m2/repository
    - node_modules/
    - target/

variables:
  M2_HOME: ".m2/repository"
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"

# not need on elksiba runner
#before_script:
#  - export http_proxy=$HTTP_PROXY; export https_proxy=$HTTPS_PROXY; export no_proxy=$NO_PROXY;
#  - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin

build-job:
  stage: build
  image: maven:3.8.5-openjdk-11-slim
  tags:
    - elksiba
  script:
#    - echo "Installing osgeo repository certificates, needed for selfsigned certificate"
#    - which java
#    - java -version
#    - echo -n | openssl s_client -connect repo.osgeo.org:443 | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' > /tmp/certOsgeo.cer
#    - keytool -import -trustcacerts -keystore /usr/local/openjdk-11/lib/security/cacerts -storepass changeit -noprompt -alias certOsgeo -file /tmp/certOsgeo.cer
    - echo "Compiling the code..."
    - mvn install -B -DskipTests
    - echo "Compile complete!"
## cannot be used with external runners
#  artifacts:
#    paths:
#      - target/

unit-test-job:   # This job runs in the test stage.
  stage: test    # It only starts when the job in the build stage completes successfully.
  image: maven:3.8.5-openjdk-11-slim
  tags:
    - elksiba
  script:
    - echo "Running unit tests..."
    - export APT_CACHE_DIR=apt-cache && mkdir -pv $APT_CACHE_DIR
    - DEBIAN_FRONTEND=noninteractive apt-get -qq update && apt-get -o dir::cache::archives="$APT_CACHE_DIR" install -y unzip nodejs npm
#    - apt update
#    - apt -o dir::cache::archives="apt-cache" install -y unzip nodejs npm
    - nodejs --version
#    - npm config rm proxy; npm config rm https-proxy; npm config --global rm proxy; npm config --global rm https-proxy
#    - npm config set proxy http://$AKKA_USR:$AKKA_PWD@and-fgt-ha.akka.eu:9090
#    - npm config set https-proxy http://$AKKA_USR:$AKKA_PWD@and-fgt-ha.akka.eu:9090
## required for selfsigned certificate
#    - npm set strict-ssl false
    - npm install -g osmtogeojson
    - mvn verify
    - echo "Unit tests execution complete."

#lint-test-job:   # This job also runs in the test stage.
#  stage: test    # It can run at the same time as unit-test-job (in parallel).
#  image: jhipster/jhipster:v7.8.1
#  tags:
#    - elksiba
#  script:
#    - echo "Linting code... This will take about 10 seconds."
#    - sleep 10
#    - echo "No lint issues found."

deploy-job:      # This job runs in the deploy stage.
  stage: deploy  # It only runs when *both* jobs in the test stage complete successfully.
  image: maven:3.8.5-openjdk-11-slim
  tags:
    - elksiba
  script:
    - echo "Deploying application..."
    - echo "Application successfully deployed."

# not need on elksiba runner
#after_script:
#  - docker logout