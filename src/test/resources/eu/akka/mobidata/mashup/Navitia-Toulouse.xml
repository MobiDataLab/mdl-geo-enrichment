<?xml version="1.0" encoding="UTF-8"?>
<spring:beans xmlns="http://www.citrusframework.org/schema/testcase"
              xmlns:http="http://www.citrusframework.org/schema/http/testcase"
              xmlns:spring="http://www.springframework.org/schema/beans"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="
    http://www.springframework.org/schema/beans 
    http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.citrusframework.org/schema/http/testcase
    http://www.citrusframework.org/schema/http/testcase/citrus-http-testcase.xsd
    http://www.citrusframework.org/schema/testcase
    http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd">

    <testcase name="Navitia-Toulouse">

        <variables>
            <variable name="geo" value=""/>
        </variables>

        <actions>
            <http:send-request client="restClient" fork="true">
                <http:GET path="/api/v1/navitia/getJourneys"/>
            </http:send-request>

            <parallel>

                <!-- Simulate Navitia API -->
                <sequential>
                    <http:receive-request server="navServer">
                        <http:GET path="/journeys?from=1.3951577;43.5690569%38to=1.4803165;43.6283803">
                            <http:param name="fmt" value="json"/>
                            <http:param name="inc" value="url-rels+release-groups"/>
                        </http:GET>
                    </http:receive-request>

                    <http:send-response server="navServer">
                        <http:headers status="200" reason-phrase="OK">
                            <http:header name="Content-Type" value="application/json"/>
                        </http:headers>
                        <http:body>
                            <http:resource
                                    file="eu/akka/mobidata/mashup/stubs/nav-Toulouse.json"/>
                        </http:body>
                    </http:send-response>
                </sequential>

                <!-- Simulate Wikipedia API -->
                <sequential>
                    <http:receive-request server="wpServer">
                        <http:GET path="/w/api.php">
                            <http:param name="action" value="query"/>
                            <http:param name="format" value="json"/>
                            <http:param name="prop" value="extracts"/>
                            <http:param name="exintro" value="true"/>
                            <http:param name="redirects" value="true"/>
                            <http:param name="titles" value="Toulouse"/>
                        </http:GET>
                    </http:receive-request>

                    <http:send-response server="wpServer">
                        <http:headers status="200" reason-phrase="OK">
                            <http:header name="Content-Type" value="application/json"/>
                        </http:headers>
                        <http:body>
                            <http:resource
                                    file="eu/akka/mobidata/mashup/stubs/wd-Toulouse.json"/>
                        </http:body>
                    </http:send-response>
                </sequential>

                <!-- Simulate Open street map API -->
                <sequential>
                    <http:receive-request server="osmServer">
                        <http:GET
                                path="/interpreter?data=[out:json];node[highway=bus_stop](43.5690569,1.3951577,43.6283803,1.4803165);out%20meta;"/>
                    </http:receive-request>

                    <http:send-response server="osmServer">
                        <http:headers status="200" reason-phrase="OK">
                            <http:header name="Content-Type" value="application/json"/>
                        </http:headers>
                        <http:body>
                            <http:resource
                                    file="eu/akka/mobidata/mashup/stubs/osm-Toulouse.json"/>
                        </http:body>
                    </http:send-response>
                </sequential>
            </parallel>

            <http:receive-response client="restClient">
                <http:body type="json">
                    <http:data>
                        {
                        "mbid" : "${mbid}",
                        "description" : "Nirvana was an American rock band...",
                        "albums" : [
                        {
                        "id" : "178b993e-fa9c-36d3-9d73-c5a8ba0c748d",
                        "title" : "Wipeout",
                        "coverArt" :
                        "http://coverartarchive.org/release/00681632-b53b-4aae-89c2-470150f33fe3/1898023189.jpg"
                        }
                        ]
                        }
                    </http:data>
                </http:body>
            </http:receive-response>
        </actions>
    </testcase>
</spring:beans>